dojo.provide("aipo.project");dojo.require("aipo.widget.DropdownDatepicker");aipo.project.FLG_ON="t";aipo.project.FLG_OFF="f";aipo.project.onLoadProjectDialog=function(e){var c=dojo.byId("urlUserlist"+e).value;var j=dojo.byId("loginUser"+e).value;var g=dojo.byId("projectUser"+e).value;if(g==0){g=j}if(c){aipo.project.changeGroup(c,"LoginUser",g,"admin_user_id")}var h=dijit.byId("membernormalselect");if(h){var k=dojo.byId("init_memberlist");var f;var b=k.options;if(b.length==1&&b[0].value==""){return}for(f=0;f<b.length;f++){h.addOptionSync(b[f].value,b[f].text,true)}}var h=dijit.byId("mapnormalselect");if(h){var k=dojo.byId("init_maplist");var f;var b=k.options;if(b.length==1&&b[0].value==""){return}for(f=0;f<b.length;f++){h.addOptionSync(b[f].value,b[f].text,true)}}var l=dojo.byId("button_member_add");if(l){dojo.connect(l,"onclick",function(){aipo.report.expandMember()})}var l=dojo.byId("button_map_add");if(l){dojo.connect(l,"onclick",function(){aipo.report.expandMap()})}var a=dojo.byId("button_member_remove");if(a){dojo.connect(a,"onclick",function(){var m=dojo.byId("members");if(m.options.length==0){if((h)&&(aipo.report.login_aliasname!="undefined")){var n=aipo.report.login_aliasname.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">");h.addOptionSync(aipo.report.login_name,n,true)}}aipo.report.expandMember()})}var a=dojo.byId("button_map_remove");if(a){dojo.connect(a,"onclick",function(){var m=dojo.byId("positions");if(m.options.length==0){if((h)&&(aipo.report.login_aliasname!="undefined")){var n=aipo.report.login_aliasname.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">");h.addOptionSync(aipo.report.login_name,n,true)}}aipo.report.expandMap()})}var d=dojo.byId("project_name");if(d){d.focus()}};aipo.project.onLoadProjectTaskDialog=function(b){var c=dojo.byId("tracker");if(c){c.focus()}var a=dojo.byId("projectId");var d=dojo.byId("mode-"+b);if(a&&d&&d.value=="insert"){a.onchange()}};aipo.project.changeGroup=function(b,d,c,a){if(!a){a="admin_user_id"}aimluck.utils.form.createSelect(a,"destuserDiv",b+"?mode=group&groupname="+d+"&inc_luser=true","userId","aliasName",c,"",'class="w49"')};aipo.project.onReceiveMessage=function(c,b){if(!c){var a=dijit.byId("modalDialog");if(a){a.hide()}aipo.project.reload()}else{if(dojo.byId("messageDiv")){dojo.byId("messageDiv").innerHTML=c;if(dojo.byId("messageDivComment")){dojo.byId("messageDivComment").innerHTML=""}}if(dojo.byId("messageDiv-"+b)){dojo.byId("messageDiv-"+b).innerHTML=c;if(dojo.byId("messageDivComment-"+b)){dojo.byId("messageDivComment-"+b).innerHTML=""}}}};aipo.project.onReceiveMessageComment=function(c,b){if(!c){var a=dijit.byId("modalDialog");if(a){a.hide()}aipo.portletReload("project")}if(dojo.byId("messageDivComment")){dojo.byId("messageDiv").innerHTML="";dojo.byId("messageDivComment").innerHTML=c}};aipo.project.formFlgToggle=function(a,b){dojo.byId(b).value=a.checked?aipo.project.FLG_ON:aipo.project.FLG_OFF};aipo.project.removeMemberForm=function(b){var a=dojo.byId("members_form");a.removeChild(dojo.byId("members_tr_"+b))};aipo.project.addMemberForm=function(){var e=dojo.byId("members_form");var f=e.children.length;f++;var c=document.createElement("td");var b=dojo.clone(dojo.byId("task_member_1"));b.id="task_member_"+f;var d=document.createElement("td");d.className="p15";d.noWrap="true";var j=document.createTextNode("  作業時間 ");var a=document.createTextNode(" h ");var k=document.createElement("input");k.type="text";k.id="workload_"+f;k.name="workload";k.className="text";k.value="";k.style.imeMode="active";k.style.width="3em";k.maxLength=5;var g=document.createElement("i");g.className="icon-remove";var l=document.createElement("a");l.appendChild(g);l.onclick=function(){aipo.project.removeMemberForm(f)};l.href="javascript:void(0);";var h=document.createElement("tr");h.id="members_tr_"+f;h.appendChild(c);c.appendChild(b);h.appendChild(d);d.appendChild(j);d.appendChild(k);d.appendChild(a);d.appendChild(l);e.appendChild(h)};aipo.project.sortsubmit=function(c){var a=c.project_so.options;var b="";for(i=0;i<a.length;i++){a[i].selected=false}if(a.length>0){b=a[0].value;for(i=1;i<a.length;i++){b=b+","+a[i].value}}c.positions.value=b};aipo.project.onChangeDate=function(l,e){var j=dojo.byId("base_date_from_year");var g=dojo.byId("base_date_from_month");var f=dojo.byId("base_date_to_year");var k=dojo.byId("base_date_to_month");var h=parseInt(j.options[j.selectedIndex].value,10);var b=parseInt(g.options[g.selectedIndex].value,10);var c=parseInt(f.options[f.selectedIndex].value,10);var a=parseInt(k.options[k.selectedIndex].value,10);if(h>c||(h==c&&b>a)){h=c;b=a}var d=l+"&base_date_from_year="+h+"&base_date_from_month="+b+"&base_date_to_year="+c+"&base_date_to_month="+a;aipo.project.viewPage(d,e)};aipo.project.onChangeProgressRate=function(f,e,a){var c=dojo.byId(a);var d=c.options[c.selectedIndex].value;var b=f+"&"+a+"="+d;aipo.project.viewPage(b,e)};aipo.project.onChangeDelay=function(b,e,d,c){aipo.project.formFlgToggle(b,e);var a=d+"&target_delay="+dojo.byId(e).value;aipo.project.viewPage(a,c)};aipo.project.onChangeProgressLine=function(a,c,b){aipo.project.formFlgToggle(a,"progress_line_checked");aipo.project.viewPage(c,b)};aipo.project.viewPage=function(c,d){var b="";var a=dojo.byId("progress_line_checked");if(a){b="&progress_line_checked="+a.value}aipo.viewPage(c+b,d);if(a){aipo.project.reloadProgress()}};aipo.project.reload=function(){aipo.portletReload("project");if(dojo.byId("progress_line_checked")){aipo.project.reloadProgress()}};aipo.project.reloadProgress=function(){var b="";var a=dojo.byId("nowTime");if(a){b=a.innerHTML}aipo.project.reloadProgressLine(b)};aipo.project.reloadProgressLine=function(b,a){if(!a){a=1}else{if(a>100){return}}setTimeout(function(){var f=new Date().getTime();var c=f;var d="";var e=dojo.byId("nowTime");if(e){d=e.innerHTML}if(d!=""&&b!=d){aipo.project.onOffProgressLine()}else{aipo.project.reloadProgressLine(b,a+1)}},100)};aipo.project.onOffProgressLine=function(){var a=dojo.byId("progress_line_checkbox");var b=dojo.byId("progress_line");if(a.checked){b.style.display="block";aipo.project.drawProgressLine()}else{b.style.display="none"}};aipo.project.drawProgressLine=function(){var w=dojo.byId("gantt_table");var b=dojo.byId("progress_line");if(b.style.setProperty){b.style.setProperty("left",w.offsetTop+"px");b.style.setProperty("top",w.offsetLeft+"px");b.style.setProperty("width",w.offsetWidth+"px");b.style.setProperty("height",w.offsetHeight+"px")}else{b.style.left=w.offsetTop+"px";b.style.top=w.offsetLeft+"px";b.style.width=w.offsetWidth+"px";b.style.height=w.offsetHeight+"px"}var f=dojo.byId("todayDay");var d=dojo.byId("count");var z=f.innerHTML;if(z==0){return}var r=20*z;var g=w.offsetTop+w.offsetHeight;var a=64;var e=30;var h="M"+r+",42";var s="L"+r+","+a;var q="L"+r+","+g;var u="";var k,j;for(var v=1;v<=d.innerHTML;v++){var n=dojo.byId("result"+v);var c=dojo.byId("plan"+v);var t=dojo.byId("progress_finish"+v);var o=dojo.byId("past_finish"+v);var p=dojo.byId("no_start"+v);k=r;j=v*e+a-(e/2);if(c){if((o&&t)||(p&&!n)){}else{if(n){k=n.offsetLeft+n.offsetWidth;j=n.offsetTop+(n.offsetHeight/2)}else{k=c.offsetLeft;j=c.offsetTop+(c.offsetHeight/2)}}}u+=" L"+k+","+j}var m=Raphael(b);var l=m.path(h+" "+s+u+" "+q);l.attr({stroke:"#ff3333","stroke-width":3})};aipo.project.toggleMenu=function(f,e,d){var c=e.getBoundingClientRect();var b=document.documentElement.getBoundingClientRect();if(f.style.display=="none"){dojo.query("div.menubar").style("display","none");var a={left:document.documentElement.scrollLeft||document.body.scrollLeft,top:document.documentElement.scrollTop||document.body.scrollTop};f.style.opacity="0";setTimeout(function(){dojo.style(f,"display","block")},0);if(b.right-f.clientWidth>c.left){f.style.left=c.left+a.left+"px"}else{f.style.left=c.right-f.clientWidth+a.left+"px"}if(b.bottom-f.clientHeight>c.bottom||d){f.style.top=c.bottom+a.top+"px"}else{f.style.top=c.top-f.clientHeight+a.top+"px"}f.style.opacity=""}else{dojo.query("div.menubar").style("display","none")}};aipo.project.filterSetDefault=function(e,d){var c=dojo.query("ul.filtertype[data-type="+d+"]")[0];var b=c.getAttribute("data-defaultparam");var a=dojo.query("li[data-param="+b+"]",c);aipo.project.filterSelect(c,a);aipo.project.filteredSearch(e)};aipo.project.filterSelect=function(b,a){dojo.query("li",b).removeClass("selected");dojo.query(a).addClass("selected")};aipo.project.filterClick=function(d,e,c){var a=e.parentNode;var b=a.parentNode;var f=a.getAttribute("data-param");aipo.project.filterSelect(b,a);aipo.project.filteredSearch(d)};aipo.project.projectFilterClick=function(c,d){var a=d.parentNode;var b=a.parentNode;aipo.project.filterSelect(b,a);aipo.project.projectSearch(c)};aipo.project.initFilterSearch=function(d){var e=dojo.byId("q"+d);var c=dojo.byId("filters_"+d);if(c&&e){var a=c.offsetWidth;if(aipo.userAgent.isAndroid4_0()){var b=dojo.query("div.filterInputField")[0];var f=parseInt(dojo.getComputedStyle(e).width);b.style.left=a+"px";c.style.left=-a+"px";e.style.width=f-a+"px";b.style.width=f-a+"px";e.style.paddingLeft="2px"}else{if(a!=0){e.style.paddingLeft=a+"px"}}}};aipo.project.finFilterSearch=function(d){if(aipo.userAgent.isAndroid4_0()){var e=dojo.byId("q"+d);var c=dojo.byId("filters_"+d);if(c&&e){var a=c.offsetWidth;var b=dojo.query("div.filterInputField")[0];var f=parseInt(dojo.getComputedStyle(e).width);b.style.left="0px";c.style.left="0px";e.style.width=f+a+"px";b.style.width=f+a+"px";e.style.paddingLeft=a+2+"px"}}};aipo.project.filteredSearch=function(d){var b=dojo.byId("baseuri_"+d).value;var c=[];var f=[];dojo.query("ul.filtertype_"+d).forEach(function(h){var j=h.getAttribute("data-type");c.push(j);var g=dojo.query("li.selected",h)[0];if(g){var k=g.getAttribute("data-param");f.push(k)}else{f.push(h.getAttribute("data-defaultparam"))}});var e=dojo.byId("q"+d);var a=[["target_user_id",f[0]],["target_tracker",f[1]],["target_priority",f[2]],["target_status",f[3]],["keyword",e?e.value:""]];aipo.viewPage(b,d,a)};aipo.project.projectSearch=function(d){var b=dojo.byId("baseuri_"+d).value;var c=[];var f=[];dojo.query("ul.filtertype_"+d).forEach(function(h){var j=h.getAttribute("data-type");c.push(j);var g=dojo.query("li.selected",h)[0];if(g){var k=g.getAttribute("data-param");f.push(k)}else{f.push(h.getAttribute("data-defaultparam"))}});var e=dojo.byId("q"+d);var a=[["filter",f.join(",")],["filtertype",c.join(",")],["keyword",e?e.value:""]];aipo.viewPage(b,d,a)};aipo.project.changeProjectMember=function(a,b){aimluck.io.sendRawData(a,b,function(c,j){if(j.type.length<=2){return}var e=dojo.query("select.sys-taskmember");e.forEach(function(l){for(var m=l.options.length;0<l.options.length-1;m--){l.options.remove(m-1)}});var g=1;var f=j.type.substr(2,j.type.length-4);var k=dojo.fromJson(f);if(dojo.isArray(k)&&k.length>0&&k[0]){var h=k[0];for(var d in h){e.forEach(function(l){l.options[g]=new Option(h[d],d)});g++}}})};aipo.project.setIndicator=function(a){obj_content=dojo.byId("content-"+a);dojo.style(obj_content,"visibility","hidden");obj_indicator=dojo.byId("indicator-"+a);dojo.style(obj_indicator,"display","")};